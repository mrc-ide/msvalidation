---
title: "Country-comparison"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Validation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Set-up

Let's begin by installing the library **malariasimulation**.

```{r setup, warning=FALSE, message=FALSE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(cowplot))
library(mlgts)
library(malariasimulation)

# remotes::install_github("mrc-ide/malariasimulation@dev", force=T)

compare_dir = 'M:/malaria_model_compare'
```

<br> 

Now let's import comparison data from comparable old model runs from the framework described in [Winskill et al. 2017](https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1002448).

```{r}
source(file.path(compare_dir, "R", "run_site.R"))

# load all site file data (do not share)
all_sites <- readRDS(file.path(compare_dir, "data", "GTS2020_sites_fitted.RDS"))
```

<br> 

# Old model

To run the old model under generic settings, we can transform country-specific values to meet the following criteria: 

1. exponential demography
2. no population growth
3. no resistance
4. NULL location (no seasonality)

We can then plot annualized clinical incidence (0-5 years) and prevalence (2-10 years) across time. In the plots below, solid lines indicate exact model estimates and dashed lines indicate smoothed estimates.

```{r, fig.height = 5, fig.width = 7, warning=FALSE, message=FALSE}
# get demography
generic_demog <- read.table(file.path(compare_dir, "data", "flat_demog.txt"))
colnames(generic_demog) <- colnames(all_sites$demog[[1]])
replace_demog <- function(x){
  generic_demog
}

# no population growth
standard_pop <- function(x){
  x$p = 1
  return(x)
}

# no resistance
standard_resistance <- function(x){
  x$resistance = 0
  return(x[1:18,])
}

# no seasonality
null_seasonality <- function(x){
  x[,1] = 1
  x[,2:7] = 0
  return(x)
}

# no interventions
null_interventions <- function(x){
  x[,c(2:4,6,8:14)] = 0
  return(x)
}

# standard vectors
standard_vectors <- function(x){
  x[,1] = 1
  x[,2:3] = 0
  return(x)
}

# choose a single site and modify parameters to equal null values
test_site <- all_sites[1, ] %>%
  # alter the population, demography, resistance, etc.
  mutate(pop = purrr::map(pop, standard_pop),
         demog = purrr::map(demog, replace_demog),
         resistance = purrr::map(resistance, standard_resistance),
         vectors = purrr::map(vectors, standard_vectors),
         seasonality = purrr::map(seasonality, null_seasonality),
         interventions = purrr::map(interventions, null_interventions),
         total_M = 10,
         num_runs = 1)

# run
output1 <- purrr::pmap(test_site, run_site) %>% bind_rows()

# plot
inc_plots <- ggplot(output1) + 
  geom_line(aes(x = t, y = clin_inc_0_5)) +
  geom_line(aes(x = t, y = clin_inc_0_5_smooth), lty = 2) +
  labs(x="Time",y="Clinical incidence 0-5") +
  theme_bw()

prev_plots <- ggplot(output1) + 
  geom_line(aes(x = t, y = prev_2_10)) +
  geom_line(aes(x = t, y = prev_2_10_smooth), lty = 2) +
  labs(x="Time",y="Prevalence 2-10") +
  theme_bw()

plot_grid(inc_plots,prev_plots)

```

<br> 

# New model

To run the new model under generic settings, we can start with the default parameters included in the **malariasimulation** package where all interventions are turned off. We can then set a run time, population, mosquito density, etc. to match our old model stipulations above.

```{r, fig.height = 5, fig.width = 7, warning=FALSE, message=FALSE}
year <- 365
warmup <- 5 * year
sim_length <- 19 * year
population <- 10000 # match run_site() documentation

# setting parameters for no individual mosquitoes
params <- malariasimulation::get_parameters(
  list(
    human_population = population,
    individual_mosquitoes = FALSE,
    model_seasonality = F,
    total_M = 10 * population,
    clinical_incidence_rendering_min_ages = 0,
    clinical_incidence_rendering_max_ages = 5 * year
  )
)

vector_params <- gamb_params
vector_params$Q0 <- test_site$vectors[[1]][[1, 'gamb_ss_Q0']]
vector_params$phi_bednets <- test_site$vectors[[1]][[1, 'gamb_ss_Q_bed']]
vector_params$phi_indoors <- test_site$vectors[[1]][[1, 'gamb_ss_Q_in']]

params <- malariasimulation::set_species(
  params,
  list(vector_params),
  proportions = 1
)

run_nmodel <- function(setparams){
  run_simulation(warmup + sim_length, setparams) %>% 
  mutate(t=timestep/365 + 1995, # assigning year
          # filling in NAs with 0
         clin_inc_0_1825=case_when(!is.na(n_inc_clinical_0_1825)~n_inc_clinical_0_1825/n_0_1825, is.na(n_inc_clinical_0_1825)~0),
         pv_730_3650=n_detect_730_3650/n_730_3650
         ) %>% 
  group_by(grp=rep(row_number(), length.out=n(), each=30)) %>% # summarize by month
  summarize(t=mean(t),
         prev_2_10=mean(pv_730_3650,na.rm=T),
         clin_inc_0_5=mean(clin_inc_0_1825,na.rm=T)*year) %>%
  filter(t >= 2000)
}

output2 <- run_nmodel(params)

# plot
inc_plots <- ggplot(output2) + 
  geom_line(aes(x = t, y = clin_inc_0_5)) +
  labs(x="Time",y="Clinical incidence 0-5") +
  theme_bw()

prev_plots <- ggplot(output2) + 
  geom_line(aes(x = t, y = prev_2_10)) +
  labs(x="Time",y="Prevalence 2-10") +
  theme_bw()

plot_grid(inc_plots,prev_plots)

```

<br>

# Comparison

Now try turning interventions on/off one at a time: 

* treatment
* bednets
* IRS
* SMC
* MDA
* RTS,S
* individual mosquitoes turned on and off

We will assess changes in prevalence and cumulative incidence for each intervention. Solid lines represent model outputs with interventions, and dashed lines represent model outputs without any interventions.

```{r, fig.height = 5, fig.width = 8, warning=FALSE, message=FALSE}
# old
output1 <- output1 %>% mutate(model="mlgts")

# new
output2 <- output2 %>%
  mutate(model="malariasimulation")

# join old and new model results into a single data set
output_orig <- full_join(output1,output2) %>%
  dplyr::select(t, prev_2_10, clin_inc_0_5, model)

# plot
inc_plots <- ggplot(output_orig) + 
  geom_line(aes(x=t, y=clin_inc_0_5, color=model)) +
  labs(x="Time",y="Clinical incidence 0-5") +
  theme_bw()

prev_plots <- ggplot(output_orig) + 
  geom_line(aes(x=t, y=prev_2_10, color=model)) +
  labs(x="Time",y="Prevalence 2-10") +
  theme_bw()

plot_grid(inc_plots,prev_plots)
```

<br> 

## Treatment

```{r, fig.height = 5, fig.width = 8, warning=FALSE, message=FALSE}
# old
test_site2 <- test_site 
test_site2$interventions[[1]]$tx <- c(rep(0,4),rep(0.8,15))
test_site2$interventions[[1]]$prop_act <- c(rep(0,4),rep(1,15))

outputA <- purrr::pmap(test_site2, run_site) %>% bind_rows() %>% mutate(model="mlgts")
  
# new
IM <- params %>% 
  set_drugs(list(AL_params, SP_AQ_params, DHA_PQP_params)) %>% 
  set_clinical_treatment(drug=2,time=5*year+warmup,coverage=0.8)

outputB <- run_nmodel(IM) %>% mutate(model="malariasimulation")
  
# join old and new model results into a single data set
output <- full_join(outputA,outputB) %>%
  dplyr::select(t, prev_2_10, clin_inc_0_5, model)

# plot
inc_plots <- function(data){
  ggplot(data) + 
  geom_line(aes(x=t, y=clin_inc_0_5, color=model)) +
  geom_line(data=output_orig,aes(x=t, y=clin_inc_0_5, color=model),lty=2) +
  labs(x="Time",y="Clinical incidence 0-5") +
  scale_y_continuous(limits=c(0,1.25)) + 
  theme_bw()
}
prev_plots <- function(data){
  ggplot(data) + 
  geom_line(aes(x=t, y=prev_2_10, color=model)) +
  geom_line(data=output_orig,aes(x=t, y=prev_2_10, color=model),lty=2) +
  labs(x="Time",y="Prevalence 2-10") +
  scale_y_continuous(limits=c(0,0.5)) + 
  theme_bw()
}

plot_grid(inc_plots(output),prev_plots(output))
```

<br> 

## Bednets

```{r, fig.height = 5, fig.width = 8, warning=FALSE, message=FALSE}
# old
test_site2 <- test_site 
test_site2$interventions[[1]]$llin <- c(rep(0,4),rep(0.8,15))
test_site2$interventions[[1]]$net_type <- c(rep("pyrethroid",19))

outputA <- purrr::pmap(test_site2, run_site) %>% bind_rows() %>% mutate(model="mlgts")
# pyrethroid params are mlgts:::r_itn(0, 0)

# new
IM <- params %>% 
  set_bednets(
    timesteps=seq(5,19,1)*year+warmup,
    coverages=rep(0.8,15),
    retention = 5 * year,
    dn0 = matrix(rep(0.3885647, 15), nrow=15, ncol=1), # or .533
    rn = matrix(rep(0.5320518, 15), nrow=15, ncol=1),
    rnm = matrix(rep(.24,15), nrow=15, ncol=1),
    gamman = rep(2.64*year,15) # or 963.6
  )

outputB <- run_nmodel(IM) %>% mutate(model="malariasimulation")

# join old and new model results into a single data set
output <- full_join(outputA,outputB) %>%
  dplyr::select(t, prev_2_10, clin_inc_0_5, model)

# plot
plot_grid(inc_plots(output),prev_plots(output))
```

<br> 

## IRS

```{r, fig.height = 5, fig.width = 8, warning=FALSE, message=FALSE}
# old
test_site2 <- test_site 
test_site2$interventions[[1]]$irs <- c(rep(0,4),rep(0.8,15))
test_site2$interventions[[1]]$irs_compound <- c(rep("actellic",19))

# params from mlgts:::r_irs(2, 0)

test_site2$interventions[[1]]$irs_rounds <- c(rep(0,4),rep(1,15))

outputA <- purrr::pmap(test_site2, run_site) %>% bind_rows() %>% mutate(model="mlgts")

# new
IM <- params %>% 
  set_spraying(
    timesteps=seq(5,19,1)*year+warmup,
    coverages=rep(0.8,15),
    ls_theta = matrix(rep(2.024412, 15), nrow=15, ncol=1),
    ls_gamma = matrix(rep(-0.008887407,15), nrow=15, ncol=1),
    ks_theta = matrix(rep(-2.222633,15), nrow=15, ncol=1),
    ks_gamma = matrix(rep(0.008469928,15), nrow=15, ncol=1),
    ms_theta = matrix(rep(1.231733,15), nrow=15, ncol=1),
    ms_gamma = matrix(rep(-0.008887407,15), nrow=15, ncol=1)
  )

outputB <- run_nmodel(IM) %>% mutate(model="malariasimulation")

# join old and new model results into a single data set
output <- full_join(outputA,outputB) %>%
  dplyr::select(t, prev_2_10, clin_inc_0_5, model)

# plot
plot_grid(inc_plots(output),prev_plots(output))
```

<br> 

## SMC

```{r, fig.height = 5, fig.width = 8, warning=FALSE, message=FALSE}
# old
test_site2 <- test_site 
test_site2$interventions[[1]]$smc <- c(rep(0,4),rep(0.8,15))
test_site2$interventions[[1]]$smc_rounds <- c(rep(0,4),rep(1,15))
# turn on seasonality

outputA <- purrr::pmap(test_site2, run_site) %>% bind_rows() %>% mutate(model="mlgts")

# new
IM <- params %>% 
   set_drugs(list(AL_params, SP_AQ_params, DHA_PQP_params)) %>%
   set_smc(drug=1,
           timesteps=seq(5,19,1)*year+warmup,
           coverages=rep(0.8,15),
           min_age=0.5*year,
           max_age=5*year)

outputB <- run_nmodel(IM) %>% mutate(model="malariasimulation")

# join old and new model results into a single data set
output <- full_join(outputA,outputB) %>%
  dplyr::select(t, prev_2_10, clin_inc_0_5, model)

# plot
plot_grid(inc_plots(output),prev_plots(output))
```

<br>

## RTS,S

```{r, fig.height = 5, fig.width = 8, warning=FALSE, message=FALSE}
# old
test_site2 <- test_site 
test_site2$interventions[[1]]$rtss <- c(rep(0,4),rep(0.8,15))
outputA <- purrr::pmap(test_site2, run_site) %>% bind_rows() %>% mutate(model="mlgts")

# new
IM <- params %>% 
  set_rtss_epi(
    start=5*year+warmup,
    end = 19*year+warmup,
    coverage=0.8,
    age=0.5*year,
    min_wait = 0,
    boosters=18*30,
    booster_coverage=0.8,
    seasonal_boosters = FALSE
  )

outputB <- run_nmodel(IM) %>% mutate(model="malariasimulation")

# join old and new model results into a single data set
output <- full_join(outputA,outputB) %>%
  dplyr::select(t, prev_2_10, clin_inc_0_5, model)

# plot
plot_grid(inc_plots(output),prev_plots(output))
```